name: Scheduled Article Generation

on:
  schedule:
    - cron: '0 1 * * *'
  workflow_dispatch:

jobs:
  generate_and_deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: 1. ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ (ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆç”¨)
        uses: actions/checkout@v4

      - name: 2. Pythonç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # ğŸš¨ ä¿®æ­£ã‚¹ãƒ†ãƒƒãƒ—: ä»®æƒ³ç’°å¢ƒã®ä½œæˆã¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€å®Ÿè¡Œã‚’çµ±åˆ ğŸš¨
      - name: 3. ä»®æƒ³ç’°å¢ƒä½œæˆã€ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
        run: |
          # ä»®æƒ³ç’°å¢ƒã‚’ä½œæˆ
          python -m venv venv
          
          # ğŸš¨ ä¿®æ­£: æ­£ã—ã„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªå 'google-generativeai' ã‚’æŒ‡å®š
          ./venv/bin/pip install google-generativeai pydantic -U
          
          # ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
          ./venv/bin/python generate_article.py
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          
      - name: 4. ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«articlesãƒ•ã‚©ãƒ«ãƒ€ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        # è¨˜äº‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ãŸå¾Œã®æ®µéšã§ã€articlesãƒ•ã‚©ãƒ«ãƒ€ã®ç—•è·¡ã‚’å‰Šé™¤
        run: |
          # articlesãƒ•ã‚©ãƒ«ãƒ€ãŒç©ºã§ãªã„å ´åˆã€ä¸­èº«ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ï¼ˆ.htmlä»¥å¤–ã‚‚å«ã‚€å¯èƒ½æ€§ï¼‰
          # ä»Šå›ã¯ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆã®ãƒªãƒã‚¸ãƒˆãƒªã§ä½œæ¥­ã™ã‚‹ãŸã‚ã€source-directoryã«ã‚ã‚‹ articlesãƒ•ã‚©ãƒ«ãƒ€è‡ªä½“ã‚’å‰Šé™¤ã€‚
          # æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã€ç”Ÿæˆã•ã‚ŒãŸ .html ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚
          rm -rf articles || true

      - name: 5. ç”Ÿæˆã•ã‚ŒãŸHTMLãƒ•ã‚¡ã‚¤ãƒ«ã®ç‰¹å®šã¨ãƒ‡ãƒ—ãƒ­ã‚¤
        uses: cpina/github-action-push-to-another-repository@main
        env:
          API_TOKEN_GITHUB: ${{ secrets.DEPLOY_TOKEN }}
        with:
          source-directory: './' 
          destination-github-username: 'kiruha0315-debug' 
          destination-repository-name: 'kiruha0315-debug.github.io' 
          user-email: 'kiruha0315-debug@users.noreply.github.com'
          commit-message: 'feat: AIã«ã‚ˆã‚‹è‡ªå‹•è¨˜äº‹ç”Ÿæˆã¨ãƒ‡ãƒ—ãƒ­ã‚¤'
          target-branch: 'main'
          target-directory: 'articles'
          create-target-branch-if-needed: true
          target-files: '*.html' # ã“ã“ã§ç”Ÿæˆã•ã‚ŒãŸ HTML ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’ãƒ—ãƒƒã‚·ãƒ¥
