name: Scheduled Article Generation

on:
  workflow_dispatch:
  schedule:
    - cron: '0 1 * * *' # æ¯æ—¥åˆå‰1æ™‚ (JST) ã«å®Ÿè¡Œ

jobs:
  generate-and-deploy:
    runs-on: ubuntu-latest

    # å¿…é ˆã®æ¨©é™è¨­å®š
    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
      - name: 1. ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: 2. Python ç’°å¢ƒè¨­å®šã¨ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          cache: 'pip'
      
      - run: python -m venv venv
      - run: ./venv/bin/pip install -r requirements.txt
      
      - name: 3. Pages ãƒ‡ãƒ—ãƒ­ã‚¤ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/configure-pages@v4

      - name: 4. è¨˜äº‹ç”Ÿæˆã¨Artifactç”¨ã®ãƒ•ã‚¡ã‚¤ãƒ«æº–å‚™
        run: |
          # è¨˜äº‹ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
          export GEMINI_API_KEY="${{ secrets.GEMINI_API_KEY }}"
          ./venv/bin/python generate_article.py
          
          # HTMLãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç‰¹å®š
          GENERATED_FILE=$(ls *.html 2>/dev/null | head -n 1) 
          
          if [ -z "$GENERATED_FILE" ]; then
            echo "âŒ è¨˜äº‹ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
            exit 1
          fi

          # ğŸš¨ ä¿®æ­£: Artifactã®ãƒ«ãƒ¼ãƒˆã¨ã—ã¦ä½¿ã† 'temp_deploy' ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ ğŸš¨
          mkdir temp_deploy
          
          # è¨˜äº‹ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã€ç”Ÿæˆç‰©ã‚’ç§»å‹•
          mkdir -p temp_deploy/articles
          mv "$GENERATED_FILE" temp_deploy/articles/
          
          # index.htmlã¨.nojekyllã‚’Artifactã®ãƒ«ãƒ¼ãƒˆã«ã‚³ãƒ”ãƒ¼ (ä»¥å‰è¿½åŠ æ¸ˆã¿)
          cp index.html temp_deploy/index.html
          cp .nojekyll temp_deploy/.nojekyll

      - name: 5. ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨Artifactã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-pages-artifact@v3
        with:
          path: temp_deploy # Artifact ã®ãƒ«ãƒ¼ãƒˆã¯ temp_deploy/

      - name: 6. GitHub Pagesã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
        id: deployment
        uses: actions/deploy-pages@v4
