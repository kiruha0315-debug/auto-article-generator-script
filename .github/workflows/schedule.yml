name: Scheduled Article Generation and Pages Deployment

on:
  schedule:
    - cron: '0 1 * * *'
  workflow_dispatch:

jobs:
  generate-and-deploy:
    runs-on: ubuntu-latest
    
    # ğŸš¨ ä¿®æ­£ç®‡æ‰€1: å¿…è¦ãªæ¨©é™ã®è¿½åŠ  ğŸš¨
    permissions:
      contents: read     # ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã™ã‚‹ãŸã‚ã«å¿…è¦
      pages: write       # GitHub Pagesã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã®ãŸã‚ã«å¿…è¦
      id-token: write    # OIDCãƒˆãƒ¼ã‚¯ãƒ³(èªè¨¼æƒ…å ±)ã®ç™ºè¡Œã®ãŸã‚ã«å¿…è¦
      
    env:
      ARTICLE_DIR: articles
    

    
    steps:
      - name: 1. ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: 2. Pythonç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 3. ä»®æƒ³ç’°å¢ƒä½œæˆã¨ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          python -m venv venv
          ./venv/bin/pip install google-generativeai pydantic -U

      - name: 4. è¨˜äº‹ç”Ÿæˆã¨ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¸ã®ä¿å­˜
        run: |
          # è¨˜äº‹ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
          export GEMINI_API_KEY="${{ secrets.GEMINI_API_KEY }}"
          ./venv/bin/python generate_article.py
          
          # HTMLãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç‰¹å®š
          GENERATED_FILE=$(ls *.html 2>/dev/null | head -n 1) 
          
          if [ -z "$GENERATED_FILE" ]; then
            echo "âŒ è¨˜äº‹ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
            exit 1
          fi

          # ğŸš¨ ä¿®æ­£1: ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆãƒªãƒã‚¸ãƒˆãƒªã«ã‚³ãƒŸãƒƒãƒˆã™ã‚‹ãŸã‚ã®æº–å‚™ ğŸš¨
          mkdir -p articles
          mv "$GENERATED_FILE" articles/
          
          # index.htmlã¨.nojekyllãŒãƒ«ãƒ¼ãƒˆã«ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª (ä»¥å‰è¿½åŠ æ¸ˆã¿)
        
      - name: 5. GitHub Pages ã¸ã®ç›´æ¥ã‚³ãƒŸãƒƒãƒˆã¨ãƒ‡ãƒ—ãƒ­ã‚¤
        uses: peaceiris/actions-gh-pages@v3
        with:
          # ğŸš¨ ä¿®æ­£2: GITHUB_TOKEN ã‚’ä½¿ã£ã¦ main ãƒ–ãƒ©ãƒ³ãƒã« articles ãƒ•ã‚©ãƒ«ãƒ€ã‚’ã‚³ãƒŸãƒƒãƒˆ ğŸš¨
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .  # ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ«ãƒ¼ãƒˆã«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã™ã¹ã¦å…¬é–‹
          force_orphan: true # å±¥æ­´ã‚’ä¸Šæ›¸ãã—ã¦ã‚¯ãƒªãƒ¼ãƒ³ãªçŠ¶æ…‹ã‚’ä¿ã¤
          
      - name: 6. GitHub Pagesã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
