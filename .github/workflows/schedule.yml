name: Scheduled Article Generation and Pages Deployment

on:
  schedule:
    - cron: '0 1 * * *'
  workflow_dispatch:

jobs:
  generate-and-deploy:
    runs-on: ubuntu-latest
    
    # 環境変数を設定 (ステップ間で共有するため)
    env:
      ARTICLE_DIR: articles # 記事をまとめるディレクトリ名
    
    steps:
      - name: 1. リポジトリをチェックアウト
        uses: actions/checkout@v4

      - name: 2. Python環境のセットアップ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 3. 仮想環境作成と依存関係のインストール
        run: |
          python -m venv venv
          ./venv/bin/pip install google-generativeai pydantic -U

      - name: 4. 記事生成と一時ディレクトリへの保存
        run: |
          # 記事生成スクリプトを実行し、HTMLファイルを生成
          ./venv/bin/python generate_article.py
          
          # 生成されたHTMLファイル名を特定 (YYYYMMDD-slug.html)
          # 注意: generate_article.pyが生成するファイル名を正確に特定できることが重要
          GENERATED_FILE=$(ls *.html | head -n 1) 
          
          # デプロイ用に 'articles' フォルダを作成し、HTMLを移動
          mkdir -p ${{ env.ARTICLE_DIR }}
          mv "$GENERATED_FILE" ${{ env.ARTICLE_DIR }}/
          
          # index.htmlが存在しないとエラーになるため、空のindex.htmlを作成 (または既存のものをコピー)
          # リポジトリのルートにindex.htmlがないとPagesが混乱する可能性
          touch index.html
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: 5. デプロイ用Artifactのアップロード
        uses: actions/upload-pages-artifact@v3
        with:
          # index.htmlとarticlesフォルダを含めてArtifactを作成
          path: .
          
      - name: 6. GitHub Pagesへのデプロイ
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          # デプロイはPagesの標準トークンで行う
          token: ${{ secrets.GITHUB_TOKEN }}
