name: Scheduled Article Generation and Pages Deployment

on:
  schedule:
    - cron: '0 1 * * *'
  workflow_dispatch:

jobs:
  generate-and-deploy:
    runs-on: ubuntu-latest
    
    # ğŸš¨ ä¿®æ­£ç®‡æ‰€1: å¿…è¦ãªæ¨©é™ã®è¿½åŠ  ğŸš¨
    permissions:
      contents: read     # ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã™ã‚‹ãŸã‚ã«å¿…è¦
      pages: write       # GitHub Pagesã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã®ãŸã‚ã«å¿…è¦
      id-token: write    # OIDCãƒˆãƒ¼ã‚¯ãƒ³(èªè¨¼æƒ…å ±)ã®ç™ºè¡Œã®ãŸã‚ã«å¿…è¦
      
    env:
      ARTICLE_DIR: articles
    

    
    steps:
      - name: 1. ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: 2. Pythonç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 3. ä»®æƒ³ç’°å¢ƒä½œæˆã¨ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          python -m venv venv
          ./venv/bin/pip install google-generativeai pydantic -U

      - name: 4. è¨˜äº‹ç”Ÿæˆã¨ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¸ã®ä¿å­˜
        run: |
          # è¨˜äº‹ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
          export GEMINI_API_KEY="${{ secrets.GEMINI_API_KEY }}"
          ./venv/bin/python generate_article.py
          
          # HTMLãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç‰¹å®š
          GENERATED_FILE=$(ls *.html 2>/dev/null | head -n 1) 
          
          # ğŸš¨ ä¿®æ­£1: Artifactã®ãƒ«ãƒ¼ãƒˆã¨ã—ã¦ä½¿ã† 'temp_deploy' ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ ğŸš¨
          mkdir temp_deploy
          
          # è¨˜äº‹ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã€ç”Ÿæˆç‰©ã‚’ç§»å‹•
          mkdir -p temp_deploy/articles
          mv "$GENERATED_FILE" temp_deploy/articles/
          
          # index.htmlã¨.nojekyllã‚’Artifactã®ãƒ«ãƒ¼ãƒˆã«ã‚³ãƒ”ãƒ¼
          cp index.html temp_deploy/index.html || true
          cp .nojekyll temp_deploy/.nojekyll || true
          
          if [ ! -f "temp_deploy/index.html" ]; then
            echo "âŒ index.htmlãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå¤±æ•—ã—ãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚"
            exit 1
          fi

      - name: 5. ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨Artifactã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-pages-artifact@v3
        with:
          # ğŸš¨ ä¿®æ­£2: Artifactã¨ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ‘ã‚¹ã‚’ 'temp_deploy' ãƒ•ã‚©ãƒ«ãƒ€ã«é™å®š ğŸš¨
          path: temp_deploy
          
      - name: 6. GitHub Pagesã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
