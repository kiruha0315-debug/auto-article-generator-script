name: Scheduled Article Generation and Pages Deployment

on:
  schedule:
    - cron: '0 1 * * *'
  workflow_dispatch:

jobs:
  generate-and-deploy:
    runs-on: ubuntu-latest
    
    # 🚨 修正箇所1: 必要な権限の追加 🚨
    permissions:
      contents: read     # リポジトリをチェックアウトするために必要
      pages: write       # GitHub Pagesへのデプロイのために必要
      id-token: write    # OIDCトークン(認証情報)の発行のために必要
      
    env:
      ARTICLE_DIR: articles
    

    
    steps:
      - name: 1. リポジトリをチェックアウト
        uses: actions/checkout@v4

      - name: 2. Python環境のセットアップ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 3. 仮想環境作成と依存関係のインストール
        run: |
          python -m venv venv
          ./venv/bin/pip install google-generativeai pydantic -U

      - name: 4. 記事生成と一時ディレクトリへの保存
        run: |
          # 🚨 修正箇所2: シェル内で直接環境変数を設定してスクリプトを実行 🚨
          # export コマンドで環境変数を設定し、同じシェルセッション内で Python スクリプトを実行
          export GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          ./venv/bin/python generate_article.py
          
          # HTMLファイルがないと次のlsがエラーになるため、エラー処理を追加
          GENERATED_FILE=$(ls *.html 2>/dev/null | head -n 1) 
          
          if [ -z "$GENERATED_FILE" ]; then
            echo "❌ 記事生成に失敗しました（HTMLファイルが見つかりません）。"
            exit 1
          fi

          mkdir -p ${{ env.ARTICLE_DIR }}
          mv "$GENERATED_FILE" ${{ env.ARTICLE_DIR }}/
          
          touch index.html
        # env: <-- ここも空でOK

      - name: 5. デプロイ用Artifactのアップロード
        uses: actions/upload-pages-artifact@v3
        with:
          path: .
          
      - name: 6. GitHub Pagesへのデプロイ
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
